#!/bin/bash
set -euf -o pipefail

DUMPDIR="/var/backup/postgresql"
mkdir -m 700 -p "$DUMPDIR"

DBLIST=$(su postgres -c "psql -q -t -c \"select datname from pg_database where not datname in (<%= @exclude_dbs.map{ |s| "'#{s}'"}.join(',') %>);\"")
for DB in $DBLIST; do
  su postgres -c "pg_dump --format=p $DB" | <%= scope['bacula::client::scriptdir'] %>/delta.sh $DUMPDIR/$DB.sql
done
su postgres -c "pg_dumpall -g" | <%= scope['bacula::client::scriptdir'] %>/delta.sh $DUMPDIR/_global.sql
